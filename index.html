<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RT Pro | RetailTraining</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RT Pro">
    <meta name="theme-color" content="#4f46e5">
    
    <link rel="apple-touch-icon" href="icon-192.png">

    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
        .btn-grad { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; transition: 0.3s; }
        .btn-grad:active { transform: scale(0.98); }
        .loader-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .opt-btn { transition: all 0.2s; border: 2px solid #e2e8f0; }
        .opt-correct { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
        .opt-wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="p-4">

    <div id="loader" class="loader-overlay hidden"><div class="spinner"></div></div>

    <div class="max-w-4xl mx-auto py-6">
        <div id="view-main" class="animate__animated animate__fadeIn">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-black text-indigo-600">RT PRO</h1>
                <p class="text-slate-500 font-medium">Training Management System</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="showView('view-staff-login')" class="glass p-8 rounded-3xl text-center cursor-pointer hover:shadow-xl transition border-b-4 border-indigo-500">
                    <div class="text-5xl mb-4">üë§</div>
                    <h2 class="text-xl font-bold">Staff</h2>
                </div>
                <div onclick="showView('view-manager-login')" class="glass p-8 rounded-3xl text-center cursor-pointer hover:shadow-xl transition border-b-4 border-emerald-500">
                    <div class="text-5xl mb-4">üìä</div>
                    <h2 class="text-xl font-bold">Manager</h2>
                </div>
                <div onclick="showView('view-supervisor-login')" class="glass p-8 rounded-3xl text-center cursor-pointer hover:shadow-xl transition border-b-4 border-purple-500">
                    <div class="text-5xl mb-4">üîë</div>
                    <h2 class="text-xl font-bold">Supervisor</h2>
                </div>
            </div>
        </div>

        <div id="view-staff-login" class="hidden animate__animated animate__fadeIn">
            <div class="glass p-8 rounded-3xl shadow-xl">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-6 flex items-center">‚Üê Back to Dashboard</button>
                <h2 class="text-2xl font-bold mb-6">Staff Access</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <button onclick="setLang('en')" id="lang-en" class="p-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-600 font-bold">English</button>
                        <button onclick="setLang('ms')" id="lang-ms" class="p-3 rounded-xl border-2 border-slate-200 font-bold">Malay</button>
                    </div>
                    <input type="text" id="staff-name" placeholder="Enter Full Name" class="w-full p-4 rounded-xl border border-slate-200 outline-none uppercase">
                    <select id="staff-outlet" class="w-full p-4 rounded-xl border border-slate-200 outline-none">
                        <option value="">Select Outlet</option>
                    </select>
                    <select id="staff-topic" class="w-full p-4 rounded-xl border border-slate-200 outline-none">
                        <option value="">Select Training Topic</option>
                    </select>
                    <button onclick="startQuiz()" class="w-full btn-grad p-4 rounded-xl font-bold text-lg shadow-lg">START QUIZ</button>
                </div>
            </div>
        </div>

        <div id="view-quiz" class="hidden">
            <div class="glass p-6 rounded-3xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <button id="quiz-back-home" onclick="goHome()" class="text-slate-400 font-bold">‚Üê Dashboard</button>
                    <div id="quiz-progress" class="font-bold text-indigo-600">Q 1/18</div>
                </div>
                <div id="q-container" class="min-h-[300px]">
                    <h3 id="q-text" class="text-xl font-bold mb-8"></h3>
                    <div id="options-grid" class="grid gap-4"></div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="next-btn" onclick="nextQuestion()" class="hidden bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">Next Question ‚Üí</button>
                    <button id="submit-quiz-btn" onclick="saveQuizResult()" class="hidden bg-emerald-600 text-white px-10 py-3 rounded-xl font-bold animate__animated animate__pulse animate__infinite">SUBMIT QUIZ üöÄ</button>
                </div>
            </div>
        </div>

        <div id="view-manager-login" class="hidden">
            <div class="glass p-8 rounded-3xl shadow-xl max-w-md mx-auto">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-6">‚Üê Back</button>
                <h2 class="text-2xl font-bold mb-6">Manager Login</h2>
                <div class="space-y-4">
                    <select id="mgr-select" onchange="updateMgrOutlets()" class="w-full p-4 rounded-xl border border-slate-200">
                        <option value="">Select Manager</option>
                    </select>
                    <select id="mgr-outlet" class="w-full p-4 rounded-xl border border-slate-200">
                        <option value="">Select Outlet</option>
                    </select>
                    <input type="password" id="mgr-pass" placeholder="Enter Password" class="w-full p-4 rounded-xl border border-slate-200">
                    <button onclick="loginManager()" class="w-full btn-grad p-4 rounded-xl font-bold">ACCESS REPORT FORM</button>
                </div>
            </div>
        </div>

        <div id="view-manager-form" class="hidden">
            <div class="glass p-8 rounded-3xl shadow-xl">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold">Staff Assessment Report</h2>
                    <button onclick="goHome()" class="bg-slate-100 p-2 rounded-lg font-bold">Logout</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 bg-slate-50 p-6 rounded-2xl">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Manager</p>
                        <p id="disp-mgr-name" class="font-bold text-lg"></p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase">Outlet</p>
                        <p id="disp-mgr-outlet" class="font-bold text-lg"></p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-2">Select Staff Member</label>
                            <select id="rep-staff" onchange="onStaffSelect()" class="w-full p-4 rounded-xl border border-slate-200 outline-none"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-2">Training Topic</label>
                            <select id="rep-topic" class="w-full p-4 rounded-xl border border-slate-200 outline-none"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-slate-100">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Score</p>
                            <p id="disp-staff-score" class="text-xl font-black text-indigo-600">--</p>
                        </div>
                        <div class="p-4 bg-white rounded-xl shadow-sm border border-slate-100">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Percentage</p>
                            <p id="disp-staff-perc" class="text-xl font-black text-indigo-600">--</p>
                        </div>
                        <div id="disp-staff-level-box" class="p-4 bg-white rounded-xl shadow-sm border border-slate-100">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">Level</p>
                            <p id="disp-staff-level" class="text-xl font-black">--</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <textarea id="mgr-comment" placeholder="Competency Comments" class="w-full p-4 border rounded-xl h-24"></textarea>
                        <textarea id="mgr-housebrand" placeholder="Housebrand Focus Points" class="w-full p-4 border rounded-xl h-24"></textarea>
                        <textarea id="mgr-gaps" placeholder="Performance Gaps" class="w-full p-4 border rounded-xl h-24"></textarea>
                        <textarea id="mgr-recom" placeholder="Recommendations" class="w-full p-4 border rounded-xl h-24"></textarea>
                    </div>

                    <div id="wrongs-container" class="p-4 bg-red-50 rounded-xl hidden">
                        <h4 class="text-sm font-bold text-red-700 mb-2">Reviewing Wrong Answers:</h4>
                        <div id="wrongs-list" class="text-xs text-red-600 space-y-1"></div>
                    </div>

                    <button onclick="submitManagerReport()" class="w-full btn-grad p-4 rounded-xl font-bold text-lg animate__animated animate__pulse">SUBMIT REPORT</button>
                </div>
            </div>
        </div>

        <div id="view-supervisor-dash" class="hidden animate__animated animate__fadeIn">
             <div class="flex justify-between items-center mb-6">
                <button onclick="goHome()" class="bg-white p-2 px-6 rounded-xl shadow font-bold">‚Üê Home</button>
                <button onclick="exportFullData()" class="bg-indigo-600 text-white p-2 px-6 rounded-xl shadow font-bold">Export Assessment + Wrongs (CSV)</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="glass p-6 rounded-3xl text-center border-b-4 border-blue-500">
                    <p class="text-xs font-black text-slate-400">TOTAL STAFF</p>
                    <h3 id="stat-staff" class="text-3xl font-black">0</h3>
                </div>
                <div class="glass p-6 rounded-3xl text-center border-b-4 border-green-500">
                    <p class="text-xs font-black text-slate-400">AVG SCORE</p>
                    <h3 id="stat-avg" class="text-3xl font-black">0%</h3>
                </div>
                <div class="glass p-6 rounded-3xl text-center border-b-4 border-orange-500">
                    <p class="text-xs font-black text-slate-400">OUTLETS</p>
                    <h3 id="stat-outlets" class="text-3xl font-black">0</h3>
                </div>
                <div class="glass p-6 rounded-3xl text-center border-b-4 border-purple-500">
                    <p class="text-xs font-black text-slate-400">REPORTS</p>
                    <h3 id="stat-reports" class="text-3xl font-black">0</h3>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-xl mb-8">
                <h3 class="text-xl font-bold mb-4">üö© Training Gaps (Top Errors)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50">
                            <tr><th class="p-3">Question Text</th><th class="p-3">Correct Ans</th><th class="p-3">Error Count</th></tr>
                        </thead>
                        <tbody id="table-gaps"></tbody>
                    </table>
                </div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-xl">
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                    <h3 class="text-xl font-bold">Assessment Log</h3>
                    <input type="text" id="log-search" onkeyup="filterLog()" placeholder="Search staff name..." class="p-2 border rounded-lg">
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 sticky top-0">
                            <tr><th class="p-3">Date</th><th class="p-3">Staff</th><th class="p-3">Outlet</th><th class="p-3">Score %</th><th class="p-3">Topic</th></tr>
                        </thead>
                        <tbody id="table-log"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="view-supervisor-login" class="hidden">
            <div class="glass p-8 rounded-3xl shadow-xl max-w-md mx-auto">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-6">‚Üê Back</button>
                <h2 class="text-2xl font-bold mb-6">Supervisor Access</h2>
                <input type="password" id="sup-pass" placeholder="Enter Admin Password" class="w-full p-4 rounded-xl border border-slate-200 outline-none mb-4">
                <button onclick="loginSupervisor()" class="w-full btn-grad p-4 rounded-xl font-bold">ACCESS DASHBOARD</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbw35eling7AQXsj6nPnwC0kW4xjlgpUui3LVlBGB_6Lh7du2h0dFieva4GwXB0LqSY/exec"; 
        
        let allQuestions = [], allResults = [], allReports = [], allWrongAnswers = [];
        let currentLang = 'en', quizIdx = 0, score = 0, currentQuizData = [], staffWrongs = [];

        const outletList = ["AJ", "B6", "BB", "BJR", "BP", "CDR", "CK", "DG", "DGD", "GB", "GBD", "GM", "HL", "HQ", "HQCT", "JL", "JLD", "JTH", "KB", "KBKK", "KBKS", "KBTJ", "KKR", "KL", "KMD", "KMN", "KMSK", "KS", "MC", "MLR", "MR", "PC", "PK", "PM", "PP", "PPK", "PSPD", "PT", "RJ", "RP", "SLS", "SMR", "ST", "TM", "TMD", "TMT", "TPOH", "TPT", "WM"];
        const managerData = [
            { id: "R1 - AMIRUL", outlets: ["DG", "DGD", "KMD", "KMN", "KMSK", "MR"] },
            { id: "R2 - HAZWANI", outlets: ["AJ", "BJR", "BP", "HQCT", "KB", "PK", "WM"] },
            { id: "R3 - HARIS", outlets: ["B6", "BB", "CDR", "HL", "BG", "KL"] },
            { id: "R4 - RAIHAN", outlets: ["GB", "GBD", "JTH", "RJ", "ST", "TPOH"] },
            { id: "R5 - ADNIN", outlets: ["JL", "JLD", "PP", "PSPD", "SMR"] },
            { id: "R6 - NADHIRAH", outlets: ["KS", "MC", "MLR", "TM", "TMD", "TMT"] },
            { id: "R7 - HASANUL", outlets: ["KBKK", "KBKS", "KBTC", "KBTJ", "PC", "PT"] },
            { id: "R8 - HAFSHAM", outlets: ["GM", "PM", "SLS", "TPT", "KKR", "PPK", "CK", "RP"] }
        ];

        window.onload = () => {
            initDropdowns();
            fetchData();
            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log("SW failed", err));
            }
        };

        async function fetchData() {
            toggleLoader(true);
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                allQuestions = data.questions;
                allResults = data.results;
                allReports = data.reports;
                allWrongAnswers = data.wrongAnswers;
                populateManagerAssessData();
            } catch (e) { console.error(e); }
            toggleLoader(false);
        }

        function initDropdowns() {
            const staffO = document.getElementById('staff-outlet');
            outletList.forEach(o => staffO.innerHTML += `<option value="${o}">${o}</option>`);
            const mgrS = document.getElementById('mgr-select');
            managerData.forEach(m => mgrS.innerHTML += `<option value="${m.id}">${m.id}</option>`);
        }

        function showView(id) {
            document.querySelectorAll('.max-w-4xl > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function goHome() { showView('view-main'); }
        function toggleLoader(s) { document.getElementById('loader').classList.toggle('hidden', !s); }
        function setLang(l) {
            currentLang = l;
            document.getElementById('lang-en').className = l === 'en' ? 'p-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-600 font-bold' : 'p-3 rounded-xl border-2 border-slate-200 font-bold';
            document.getElementById('lang-ms').className = l === 'ms' ? 'p-3 rounded-xl border-2 border-indigo-600 bg-indigo-50 text-indigo-600 font-bold' : 'p-3 rounded-xl border-2 border-slate-200 font-bold';
        }

        // --- QUIZ LOGIC ---
        function startQuiz() {
            const name = document.getElementById('staff-name').value;
            const topic = document.getElementById('staff-topic').value;
            const outlet = document.getElementById('staff-outlet').value;
            if(!name || !topic || !outlet) return alert("Fill all details");
            
            currentQuizData = allQuestions.filter(q => q.topic == topic);
            if(currentQuizData.length == 0) return alert("No questions found for this topic");
            
            quizIdx = 0; score = 0; staffWrongs = [];
            renderQuestion();
            showView('view-quiz');
        }

        function renderQuestion() {
            const q = currentQuizData[quizIdx];
            document.getElementById('quiz-back-home').classList.toggle('hidden', quizIdx > 0);
            document.getElementById('quiz-progress').innerText = `Q ${quizIdx+1}/${currentQuizData.length}`;
            document.getElementById('q-text').innerText = currentLang === 'en' ? q.question_en : q.question_ms;
            
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            for(let i=1; i<=4; i++) {
                const optText = currentLang === 'en' ? q[`opt${i}_en`] : q[`opt${i}_ms`];
                if(!optText || optText === "") continue;
                const btn = document.createElement('button');
                btn.className = "opt-btn p-4 rounded-xl text-left font-medium bg-white";
                btn.innerText = optText;
                btn.onclick = () => handleChoice(i, btn, q);
                grid.appendChild(btn);
            }
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('submit-quiz-btn').classList.add('hidden');
        }

        function handleChoice(idx, btn, q) {
            document.querySelectorAll('.opt-btn').forEach(b => b.onclick = null);
            const isCorrect = idx == q.correct;
            if(isCorrect) {
                btn.classList.add('opt-correct');
                score++;
            } else {
                btn.classList.add('opt-wrong');
                document.querySelectorAll('.opt-btn')[q.correct - 1].classList.add('opt-correct');
                staffWrongs.push({
                    qId: q.topic + "_" + quizIdx,
                    qText: currentLang === 'en' ? q.question_en : q.question_ms,
                    userChoice: currentLang === 'en' ? q[`opt${idx}_en`] : q[`opt${idx}_ms`],
                    correctText: currentLang === 'en' ? q[`opt${q.correct}_en`] : q[`opt${q.correct}_ms`]
                });
            }
            if(quizIdx < currentQuizData.length - 1) document.getElementById('next-btn').classList.remove('hidden');
            else document.getElementById('submit-quiz-btn').classList.remove('hidden');
        }

        function nextQuestion() { quizIdx++; renderQuestion(); }

        async function saveQuizResult() {
            toggleLoader(true);
            const payload = {
                action: 'save_result',
                name: document.getElementById('staff-name').value.toUpperCase(),
                outlet: document.getElementById('staff-outlet').value,
                topic: document.getElementById('staff-topic').value,
                score: `${score}/${currentQuizData.length}`,
                perc: Math.round((score/currentQuizData.length)*100) + "%",
                wrongAnswers: staffWrongs
            };
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("Quiz Submitted!");
            location.reload();
        }

        // --- MANAGER LOGIC ---
        function loginManager() {
            if(document.getElementById('mgr-pass').value === "1234") showView('view-manager-form');
            else alert("Wrong password");
        }

        function updateMgrOutlets() {
            const m = managerData.find(x => x.id === document.getElementById('mgr-select').value);
            const outS = document.getElementById('mgr-outlet');
            outS.innerHTML = '<option value="">Select Outlet</option>';
            if(m) m.outlets.forEach(o => outS.innerHTML += `<option value="${o}">${o}</option>`);
        }

        function populateManagerAssessData() {
            const topics = [...new Set(allQuestions.map(q => q.topic))];
            const ts = document.getElementById('rep-topic');
            const sts = document.getElementById('rep-staff');
            const stsLogin = document.getElementById('staff-topic');
            ts.innerHTML = '<option value="">Select Topic</option>';
            stsLogin.innerHTML = '<option value="">Select Training Topic</option>';
            topics.forEach(t => { 
                ts.innerHTML += `<option>${t}</option>`;
                stsLogin.innerHTML += `<option>${t}</option>`;
            });
            sts.innerHTML = '<option value="">Select Staff</option>';
            allResults.forEach(r => sts.innerHTML += `<option value="${r.Name}">${r.Name} (${r.Topic})</option>`);
        }

        function onStaffSelect() {
            const name = document.getElementById('rep-staff').value;
            const res = allResults.find(r => r.Name === name);
            if(res) {
                document.getElementById('disp-staff-score').innerText = res.Score;
                document.getElementById('disp-staff-perc').innerText = res.Percentage;
                const p = parseInt(res.Percentage);
                let lvl = "LOW", col = "text-red-600";
                if(p >= 85) { lvl = "HIGH"; col = "text-emerald-600"; }
                else if(p >= 71) { lvl = "MEDIUM"; col = "text-orange-500"; }
                const lEl = document.getElementById('disp-staff-level');
                lEl.innerText = lvl; lEl.className = "text-xl font-black " + col;
                
                const wrongs = allWrongAnswers.filter(w => w["Staff Name"] === name);
                const wCont = document.getElementById('wrongs-container');
                const wList = document.getElementById('wrongs-list');
                if(wrongs.length > 0) {
                    wCont.classList.remove('hidden');
                    wList.innerHTML = wrongs.map(w => `‚Ä¢ ${w["Question Text"]} (Ans: ${w["Correct Answer"]})`).join('<br>');
                } else wCont.classList.add('hidden');
            }
        }

        async function submitManagerReport() {
            toggleLoader(true);
            const payload = {
                action: 'save_report',
                manager: document.getElementById('mgr-select').value,
                outlet: document.getElementById('mgr-outlet').value,
                staffName: document.getElementById('rep-staff').value,
                quizScore: document.getElementById('disp-staff-perc').innerText,
                trainingTitle: document.getElementById('rep-topic').value,
                skillLevel: document.getElementById('disp-staff-level').innerText,
                competencyComments: document.getElementById('mgr-comment').value,
                housebrandFocus: document.getElementById('mgr-housebrand').value,
                performanceGaps: document.getElementById('mgr-gaps').value,
                recommendations: document.getElementById('mgr-recom').value
            };
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("Report Submitted!");
            location.reload();
        }

        // --- SUPERVISOR LOGIC ---
        function loginSupervisor() {
            if(document.getElementById('sup-pass').value === "admin") {
                renderSupervisorStats();
                showView('view-supervisor-dash');
            } else alert("Denied");
        }

        function renderSupervisorStats() {
            document.getElementById('stat-staff').innerText = allResults.length;
            document.getElementById('stat-reports').innerText = allReports.length;
            document.getElementById('stat-outlets').innerText = [...new Set(allResults.map(r => r.Outlet))].length;
            const avg = allResults.length ? Math.round(allResults.reduce((a,b)=>a+parseInt(b.Percentage),0)/allResults.length) : 0;
            document.getElementById('stat-avg').innerText = avg + "%";

            document.getElementById('table-log').innerHTML = allResults.map(r => `
                <tr class="border-b">
                    <td class="p-3 text-slate-400">${new Date(r.Timestamp).toLocaleDateString()}</td>
                    <td class="p-3 font-bold">${r.Name}</td>
                    <td class="p-3">${r.Outlet}</td>
                    <td class="p-3 text-indigo-600 font-bold">${r.Percentage}</td>
                    <td class="p-3 text-xs">${r.Topic}</td>
                </tr>
            `).join('');

            const gaps = {};
            allWrongAnswers.forEach(w => {
                gaps[w["Question Text"]] = (gaps[w["Question Text"]] || 0) + 1;
            });
            document.getElementById('table-gaps').innerHTML = Object.entries(gaps).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([q, count]) => `
                <tr class="border-b">
                    <td class="p-3 font-medium">${q}</td>
                    <td class="p-3 text-emerald-600 font-bold">See Master</td>
                    <td class="p-3 font-black text-red-500">${count} Errors</td>
                </tr>
            `).join('');
        }

        function exportFullData() {
            let csv = "Timestamp,Staff,Outlet,Topic,Score,Percentage,Wrong_Answers\n";
            allResults.forEach(r => {
                const wrongs = allWrongAnswers.filter(w => w["Staff Name"] === r.Name).map(w => w["Question Text"]).join(" | ");
                csv += `"${r.Timestamp}","${r.Name}","${r.Outlet}","${r.Topic}","${r.Score}","${r.Percentage}","${wrongs}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'RT_Pro_Full_Data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    </script>
</body>
</html>
