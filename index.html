<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RT Pro | RetailTraining</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RT Pro">
    <link rel="apple-touch-icon" href="icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('SW Registered'))
        .catch(err => console.log('SW Registration Failed', err));
    });
  }
</script>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
        .btn-grad { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; transition: 0.3s; }
        .btn-grad:active { transform: scale(0.96); }
        .loader-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.9); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .opt-btn { transition: all 0.2s; border: 2px solid #e2e8f0; text-align: left; padding: 1.25rem; border-radius: 1rem; background: white; font-weight: 500; width: 100%; margin-bottom: 0.75rem; }
        .opt-correct { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #166534 !important; }
        .opt-wrong { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #991b1b !important; }
        .hidden { display: none !important; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loader" class="loader-overlay hidden">
        <div class="spinner"></div>
        <p id="loader-text" class="mt-4 font-bold text-indigo-600 animate-pulse">Syncing Cloud...</p>
    </div>

    <div class="max-w-4xl mx-auto">
        <div id="view-main" class="animate__animated animate__fadeIn">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-black text-indigo-600 tracking-tight">RT PRO</h1>
                <p class="text-slate-500 font-medium">Retail Training Management</p>
            </header>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="showView('view-staff-login')" class="glass p-8 rounded-3xl text-center cursor-pointer shadow-lg border-b-4 border-indigo-500 active:scale-95 transition">
                    <div class="text-5xl mb-4">üë§</div>
                    <h2 class="text-xl font-bold">Staff</h2>
                </div>
                <div onclick="showView('view-manager-login')" class="glass p-8 rounded-3xl text-center cursor-pointer shadow-lg border-b-4 border-emerald-500 active:scale-95 transition">
                    <div class="text-5xl mb-4">üìä</div>
                    <h2 class="text-xl font-bold">Manager</h2>
                </div>
                <div onclick="showView('view-supervisor-login')" class="glass p-8 rounded-3xl text-center cursor-pointer shadow-lg border-b-4 border-purple-500 active:scale-95 transition">
                    <div class="text-5xl mb-4">üîë</div>
                    <h2 class="text-xl font-bold">Supervisor</h2>
                </div>
            </div>
        </div>

        <div id="view-staff-login" class="hidden animate__animated animate__fadeIn">
            <div class="glass p-8 rounded-3xl shadow-xl space-y-4">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-2">‚Üê Back</button>
                <h2 class="text-2xl font-bold">Staff Entry</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setLang('en')" id="lang-en" class="p-3 rounded-xl border-2 border-indigo-600 bg-indigo-600 text-white font-bold">English</button>
                    <button onclick="setLang('ms')" id="lang-ms" class="p-3 rounded-xl border-2 border-slate-200 font-bold">Malay</button>
                </div>
                <input type="text" id="staff-name" placeholder="Full Name" class="w-full p-4 rounded-xl border uppercase">
                <select id="staff-outlet" class="w-full p-4 rounded-xl border bg-white">
                    <option value="">Select Outlet</option>
                </select>
                <select id="staff-topic" class="w-full p-4 rounded-xl border bg-white font-bold text-indigo-600">
                    <option value="">Select Training Topic</option>
                </select>
                <button onclick="startQuiz()" class="w-full btn-grad p-4 rounded-xl font-bold text-lg">ENTER QUIZ</button>
            </div>
        </div>

        <div id="view-quiz" class="hidden">
            <div class="glass p-6 rounded-3xl shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <button id="quiz-back-btn" onclick="location.reload()" class="text-slate-400 font-bold">‚Üê Exit</button>
                    <div id="quiz-progress" class="font-bold text-indigo-600 bg-indigo-50 px-4 py-1 rounded-full">Q 1</div>
                </div>
                <div id="q-container" class="min-h-[250px]">
                    <h3 id="q-text" class="text-xl font-bold mb-8 leading-tight"></h3>
                    <div id="options-grid"></div>
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="next-btn" onclick="nextQuestion()" class="hidden bg-slate-800 text-white px-8 py-3 rounded-xl font-bold">Next ‚Üí</button>
                    <button id="submit-quiz-btn" onclick="saveQuizResult()" class="hidden bg-emerald-600 text-white px-10 py-3 rounded-xl font-bold">SUBMIT</button>
                    <button id="finish-preview-btn" onclick="showView('view-supervisor-dash')" class="hidden bg-indigo-600 text-white px-10 py-3 rounded-xl font-bold">Finish Preview</button>
                </div>
            </div>
        </div>

        <div id="view-supervisor-dash" class="hidden animate__animated animate__fadeIn">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex gap-2">
                    <button onclick="goHome()" class="bg-white p-2 px-6 rounded-xl shadow font-bold">‚Üê Home</button>
                    <div class="flex bg-white p-1 rounded-xl shadow border">
                        <select id="sup-preview-topic" class="text-xs p-1 outline-none border-none bg-transparent max-w-[120px] md:max-w-none">
                            <option value="">Preview Topic...</option>
                        </select>
                        <button onclick="startPreview()" class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-xs font-bold">Preview</button>
                    </div>
                </div>
                <button onclick="exportComprehensiveCSV()" class="bg-indigo-600 text-white p-3 px-6 rounded-xl shadow-lg font-bold">Download Full Linked Report (CSV)</button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 text-center">
                <div class="glass p-4 rounded-2xl border-b-4 border-blue-500"><p class="text-[10px] text-slate-400 uppercase">Staff</p><h3 id="stat-staff" class="text-2xl font-black">0</h3></div>
                <div class="glass p-4 rounded-2xl border-b-4 border-green-500"><p class="text-[10px] text-slate-400 uppercase">Avg Accuracy</p><h3 id="stat-avg" class="text-2xl font-black">0%</h3></div>
                <div class="glass p-4 rounded-2xl border-b-4 border-orange-500"><p class="text-[10px] text-slate-400 uppercase">Outlets</p><h3 id="stat-outlets" class="text-2xl font-black">0</h3></div>
                <div class="glass p-4 rounded-2xl border-b-4 border-purple-500"><p class="text-[10px] text-slate-400 uppercase">Reports</p><h3 id="stat-reports" class="text-2xl font-black">0</h3></div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-xl mb-8 border-l-8 border-emerald-500">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                    <div>
                        <h3 class="text-xl font-bold text-emerald-600">üìù Manager Report Submissions</h3>
                        <p class="text-[10px] text-slate-400 italic">Showing 20 most recent submissions</p>
                    </div>
                    <input type="text" id="report-search" onkeyup="filterReports()" placeholder="Search Name or Outlet..." class="p-2 px-4 rounded-xl border text-sm w-full md:w-64 focus:ring-2 focus:ring-emerald-200 outline-none">
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-emerald-50 text-emerald-800"><tr><th class="p-3">Staff</th><th class="p-3">Outlet</th><th class="p-3">Level</th><th class="p-3">Gaps</th><th class="p-3">Recommendations</th></tr></thead><tbody id="table-reports"></tbody></table></div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-xl mb-8 border-l-8 border-red-500">
                <h3 class="text-xl font-bold mb-4 text-red-600">üö© Training Gaps</h3>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-red-50 text-red-800"><tr><th class="p-3">Question Text</th><th class="p-3">Correct Answer</th><th class="p-3 text-center">Errors</th></tr></thead><tbody id="table-gaps"></tbody></table></div>
            </div>

            <div class="glass p-6 rounded-3xl shadow-xl">
                <h3 class="text-xl font-bold mb-4">Assessment History Log <span class="text-xs font-normal text-slate-400">(Recent 50)</span></h3>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead><tr class="bg-slate-50 text-slate-500"><th class="p-3">Date</th><th class="p-3">Staff</th><th class="p-3">Outlet</th><th class="p-3">Score %</th><th class="p-3">Topic</th></tr></thead><tbody id="table-log"></tbody></table></div>
            </div>
        </div>

        <div id="view-manager-login" class="hidden">
            <div class="glass p-8 rounded-3xl shadow-xl max-w-md mx-auto space-y-4">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-2">‚Üê Back</button>
                <h2 class="text-2xl font-bold">Manager Login</h2>
                <select id="mgr-select" onchange="updateMgrOutlets()" class="w-full p-4 rounded-xl border">
                    <option value="">Select Manager</option>
                </select>
                <select id="mgr-outlet" class="w-full p-4 rounded-xl border">
                    <option value="">Select Outlet</option>
                </select>
                <input type="password" id="mgr-pass" placeholder="Pin Code" class="w-full p-4 rounded-xl border">
                <button onclick="loginManager()" class="w-full btn-grad p-4 rounded-xl font-bold">Enter Dashboard</button>
            </div>
        </div>

        <div id="view-manager-form" class="hidden">
            <div class="glass p-6 rounded-3xl shadow-xl space-y-6">
                <div class="flex justify-between items-center border-b pb-4">
                    <div>
                        <h2 class="text-xl font-bold text-indigo-600 leading-tight">Region Assessment</h2>
                        <p id="edit-indicator" class="text-[10px] text-orange-500 font-bold hidden uppercase tracking-widest">‚óè Modifying Existing Report</p>
                    </div>
                    <button onclick="location.reload()" class="text-red-500 font-bold text-sm">Logout</button>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl grid grid-cols-2 text-xs font-bold">
                    <div><p class="text-slate-400 uppercase">Assessing Manager</p><p id="disp-mgr-name" class="text-indigo-600"></p></div>
                    <div><p class="text-slate-400 uppercase">Outlet</p><p id="disp-mgr-outlet" class="text-indigo-600"></p></div>
                </div>

                <div class="space-y-3">
                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Step 1: Select Topic</p>
                    <select id="rep-topic-filter" onchange="updateStaffByTopic()" class="w-full p-4 rounded-xl border bg-white font-bold text-indigo-600">
                        <option value="">Choose Topic First...</option>
                    </select>

                    <p class="text-xs font-bold text-slate-500 uppercase tracking-wider">Step 2: Select Staff Member</p>
                    <select id="rep-staff" onchange="onStaffSelect()" class="w-full p-4 rounded-xl border font-bold text-indigo-700">
                        <option value="">Then choose Staff...</option>
                    </select>
                </div>
                
                <input type="date" id="rep-date" class="w-full p-4 rounded-xl border">
                
                <div id="wrongs-container" class="p-4 bg-red-50 rounded-xl hidden text-[11px] text-red-700 border border-red-100 shadow-inner">
                    <p class="font-black mb-2 uppercase tracking-widest flex items-center">
                        <span class="mr-2">üö©</span> Quiz Misconceptions
                    </p>
                    <div id="wrongs-list" class="space-y-2"></div>
                </div>

                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white p-3 rounded-xl border"><p class="text-[10px] text-slate-400 uppercase">Score</p><p id="disp-staff-score" class="text-lg font-black"></p></div>
                    <div class="bg-white p-3 rounded-xl border"><p class="text-[10px] text-slate-400 uppercase">Accuracy</p><p id="disp-staff-perc" class="text-lg font-black"></p></div>
                    <div id="disp-staff-level-box" class="p-3 rounded-xl text-white font-bold uppercase"><p class="text-[10px]">Competency</p><p id="disp-staff-level" class="text-lg"></p></div>
                </div>
                <textarea id="mgr-comment" placeholder="Competency Comments" class="w-full p-4 border rounded-xl h-24 outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                <textarea id="mgr-housebrand" placeholder="Housebrand Focus Points" class="w-full p-4 border rounded-xl h-20 outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                <textarea id="mgr-gaps" placeholder="Performance Gaps" class="w-full p-4 border rounded-xl h-20 outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                <textarea id="mgr-recom" placeholder="Recommendations" class="w-full p-4 border rounded-xl h-20 outline-none focus:ring-2 focus:ring-indigo-100"></textarea>
                
                <button onclick="submitManagerReport()" class="w-full btn-grad p-4 rounded-xl font-bold uppercase tracking-widest active:scale-95 transition">Submit Performance Report</button>
            </div>
        </div>

        <div id="view-supervisor-login" class="hidden">
            <div class="glass p-8 rounded-3xl shadow-xl max-w-md mx-auto space-y-4 text-center">
                <button onclick="goHome()" class="text-indigo-600 font-bold mb-2 flex items-center">‚Üê Back</button>
                <h2 class="text-2xl font-bold">Admin Portal</h2>
                <input type="password" id="sup-pass" placeholder="PIN" class="w-full p-4 rounded-xl border">
                <button onclick="loginSupervisor()" class="w-full btn-grad p-4 rounded-xl font-bold">Login</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyHp52VOZXi7q3xyxgfuQ3u0ti8M5q2RagaC8zeQn4PAT4c4lGJGUEnopsfTU-fIbI3/exec"; 
        
        let allQuestions = [], allResults = [], allReports = [], allWrongAnswers = [];
        let currentLang = 'en', quizIdx = 0, score = 0, currentQuizData = [], staffWrongs = [];
        let isQuizRunning = false, isPreviewMode = false;

        // FIXED LIST AND REGIONS
        const outletList = ["AJ", "B6", "BB", "BJR", "BP", "CDR", "CK", "DG", "DGD", "GB", "GBD", "GM", "HL", "HQ", "HQCT", "JL", "JLD", "JTH", "KB", "KBKK", "KBKS", "KBTJ", "KKR", "KL", "KMD", "KMN", "KMSK", "KS", "MC", "MLR", "MR", "PC", "PK", "PM", "PP", "PPK", "PSPD", "PT", "RJ", "SLS", "SMR", "ST", "TM", "TMD", "TMT", "TPOH", "TPT", "WM"];
        const managerData = [
            { id: "R1 - AMIRUL", outlets: ["DG", "DGD", "KMD", "KMN", "KMSK", "MR"] },
            { id: "R2 - HAZWANI", outlets: ["AJ", "BJR", "BP", "HQCT", "KB", "PK", "WM"] },
            { id: "R3 - HARIS", outlets: ["B6", "BB", "CDR", "HL", "HQ", "KL"] },
            { id: "R4 - RAIHAN", outlets: ["GB", "GBD", "JTH", "RJ", "ST", "TPOH"] },
            { id: "R5 - ADNIN", outlets: ["JL", "JLD", "PP", "PSPD", "SMR"] },
            { id: "R6 - NADHIRAH", outlets: ["KS", "MC", "MLR", "TM", "TMD", "TMT"] },
            { id: "R7 - HASANUL", outlets: ["KBKK", "KBKS", "KBTJ", "PC", "PT"] },
            { id: "R8 - HAFSHAM", outlets: ["PM", "SLS", "TPT", "KKR", "PPK"] },
            { id: "R9 - IFFAH / RAIHAN", outlets: ["GM", "CK"] }
        ];

        window.onload = () => { initDropdowns(); fetchData(); };
        window.onbeforeunload = function() { if(isQuizRunning && !isPreviewMode) { autoSubmitQuiz(); return "Unsaved Progress."; } };

        async function fetchData() {
            setLoader(true, "Synchronizing...");
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                allQuestions = data.questions || [];
                allResults = data.results || [];
                allReports = data.reports || [];
                allWrongAnswers = data.wrongAnswers || [];
                populateGlobalData();
            } catch (e) { alert("Fetch Error"); }
            setLoader(false);
        }

        function initDropdowns() {
            const staffO = document.getElementById('staff-outlet');
            staffO.innerHTML = '<option value="">Select Outlet</option>';
            outletList.forEach(o => staffO.innerHTML += `<option value="${o}">${o}</option>`);
            const mgrS = document.getElementById('mgr-select');
            mgrS.innerHTML = '<option value="">Select Manager</option>';
            managerData.forEach(m => mgrS.innerHTML += `<option value="${m.id}">${m.id}</option>`);
        }

        function populateGlobalData() {
            const activeTopics = [...new Set(allQuestions.filter(q => (q.status || q.Status || q.STATUS) !== "Inactive").map(q => q.topic))].filter(t => t);
            
            const staffTopic = document.getElementById('staff-topic');
            staffTopic.innerHTML = '<option value="">Select Training Topic</option>';
            activeTopics.forEach(t => staffTopic.innerHTML += `<option value="${t}">${t}</option>`);
            
            const supTopic = document.getElementById('sup-preview-topic');
            supTopic.innerHTML = '<option value="">Preview Topic...</option>';
            activeTopics.forEach(t => supTopic.innerHTML += `<option value="${t}">${t}</option>`);

            const mgrTopic = document.getElementById('rep-topic-filter');
            mgrTopic.innerHTML = '<option value="">Choose Topic First...</option>';
            activeTopics.forEach(t => mgrTopic.innerHTML += `<option value="${t}">${t}</option>`);
        }

        function updateStaffByTopic() {
            const topic = document.getElementById('rep-topic-filter').value;
            const outlet = document.getElementById('disp-mgr-outlet').innerText;
            const staffSelect = document.getElementById('rep-staff');
            const mName = document.getElementById('disp-mgr-name').innerText;
            
            staffSelect.innerHTML = '<option value="">Choose Staff...</option>';
            
            if(!topic) return;

            // Filter results for that outlet AND that topic
            const staffWhoTookQuiz = allResults.filter(r => r.Outlet === outlet && r.Topic === topic);
            
            staffWhoTookQuiz.forEach(r => {
                // Check if manager already submitted for this specific staff + topic
                const isSubmitted = allReports.some(rep => 
                    rep["Staff Name"].trim().toUpperCase() === r.Name.trim().toUpperCase() && 
                    rep["Training Title"] === topic
                );

                const statusLabel = isSubmitted ? "‚úÖ [SUBMITTED]" : "‚ùå [PENDING]";
                staffSelect.innerHTML += `<option value="${r.Name}">${statusLabel} ${r.Name}</option>`;
            });
        }

        function onStaffSelect() {
            const n = document.getElementById('rep-staff').value;
            const o = document.getElementById('disp-mgr-outlet').innerText;
            const topic = document.getElementById('rep-topic-filter').value;
            const m = document.getElementById('disp-mgr-name').innerText;
            const r = allResults.find(x => x.Name === n && x.Outlet === o && x.Topic === topic);
            
            // Reset fields
            document.getElementById('mgr-comment').value = "";
            document.getElementById('mgr-housebrand').value = "";
            document.getElementById('mgr-gaps').value = "";
            document.getElementById('mgr-recom').value = "";
            document.getElementById('edit-indicator').classList.add('hidden');

            if(r) {
                document.getElementById('disp-staff-score').innerText = r.Score;
                document.getElementById('disp-staff-perc').innerText = formatToPercent(r.Percentage);
                const p = parseInt(formatToPercent(r.Percentage));
                let lvl = "LOW", col = "#ef4444";
                if(p >= 85) { lvl = "HIGH"; col = "#10b981"; }
                else if(p >= 71) { lvl = "MEDIUM"; col = "#f59e0b"; }
                document.getElementById('disp-staff-level').innerText = lvl; 
                document.getElementById('disp-staff-level-box').style.backgroundColor = col;

                // Load existing data if report exists
                const existing = allReports.find(x => x["Staff Name"].trim().toUpperCase() === n.trim().toUpperCase() && x["Training Title"] === topic);
                if (existing) {
                    if (existing["Manager"] === m) {
                        document.getElementById('mgr-comment').value = existing["Competency Comments"] || "";
                        document.getElementById('mgr-housebrand').value = existing["Housebrand Focus"] || "";
                        document.getElementById('mgr-gaps').value = existing["Performance Gaps"] || "";
                        document.getElementById('mgr-recom').value = existing["Recommendations"] || "";
                        document.getElementById('edit-indicator').classList.remove('hidden');
                    } else {
                        alert(`Note: ${existing["Manager"]} has already submitted a report for this session. You cannot edit it.`);
                        document.getElementById('rep-staff').value = "";
                    }
                }

                const wr = allWrongAnswers.filter(w => w["Staff Name"] === n && w["Topic"] === r.Topic);
                const cont = document.getElementById('wrongs-container');
                if(wr.length > 0) {
                    cont.classList.remove('hidden');
                    document.getElementById('wrongs-list').innerHTML = wr.map(w => `<div class="bg-white p-2 rounded border border-red-50 mb-1 shadow-sm"><span class="font-bold text-red-900 block">Q: ${w["Question Text"]}</span><span class="text-green-700 font-black block mt-1">‚úì Correct: ${w["Correct Answer"]}</span></div>`).join('');
                } else cont.classList.add('hidden');
            }
        }

        function startPreview() {
            const t = document.getElementById('sup-preview-topic').value;
            if(!t) return alert("Select a topic");
            currentQuizData = allQuestions.filter(q => q.topic == t);
            quizIdx = 0; score = 0; isPreviewMode = true; isQuizRunning = false;
            renderQuestion(); showView('view-quiz');
        }

        function setLoader(show, text = "Processing...") {
            const l = document.getElementById('loader');
            document.getElementById('loader-text').innerText = text;
            l.classList.toggle('hidden', !show);
        }

        function showView(id) {
            document.querySelectorAll('.max-w-4xl > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function goHome() { isQuizRunning = false; isPreviewMode = false; showView('view-main'); }
        function setLang(l) {
            currentLang = l;
            document.getElementById('lang-en').className = l === 'en' ? 'p-3 rounded-xl border-2 border-indigo-600 bg-indigo-600 text-white font-bold' : 'p-3 rounded-xl border-2 border-slate-200 font-bold';
            document.getElementById('lang-ms').className = l === 'ms' ? 'p-3 rounded-xl border-2 border-indigo-600 bg-indigo-600 text-white font-bold' : 'p-3 rounded-xl border-2 border-slate-200 font-bold';
        }

        function startQuiz() {
            const n = document.getElementById('staff-name').value;
            const t = document.getElementById('staff-topic').value;
            const o = document.getElementById('staff-outlet').value;
            if(!n || !t || !o) return alert("All fields required");
            currentQuizData = allQuestions.filter(q => q.topic == t);
            quizIdx = 0; score = 0; staffWrongs = [];
            isQuizRunning = true; isPreviewMode = false;
            renderQuestion(); showView('view-quiz');
        }

        function renderQuestion() {
            const q = currentQuizData[quizIdx];
            document.getElementById('quiz-progress').innerText = `Q ${quizIdx+1}/${currentQuizData.length}`;
            document.getElementById('q-text').innerText = currentLang === 'en' ? q.question_en : (q.question_ms || q.question_en);
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            
            for(let i=1; i<=4; i++) {
                let optEn = q[`opt${i}_en` || `Opt${i}_en` || `OPT${i}_EN` ];
                let optMs = q[`opt${i}_ms` || `Opt${i}_ms` || `OPT${i}_MS` ];
                let txt = currentLang === 'en' ? optEn : (optMs || optEn);
                let cleanTxt = (txt !== undefined && txt !== null) ? txt.toString().trim() : "";

                if (cleanTxt !== "" && cleanTxt.toLowerCase() !== "undefined") {
                    const b = document.createElement('button');
                    b.className = "opt-btn shadow-sm animate__animated animate__fadeInUp";
                    b.innerText = cleanTxt;
                    b.onclick = () => handleChoice(i - 1, b, q); 
                    grid.appendChild(b);
                }
            }
            document.getElementById('next-btn').classList.add('hidden');
            document.getElementById('submit-quiz-btn').classList.add('hidden');
            document.getElementById('finish-preview-btn').classList.add('hidden');
        }

        function handleChoice(idx, btn, q) {
            const buttons = document.querySelectorAll('.opt-btn');
            buttons.forEach(b => b.onclick = null);
            const correctIdx = parseInt(q.correct);
            if (idx === correctIdx) { btn.classList.add('opt-correct'); score++; } 
            else {
                btn.classList.add('opt-wrong');
                buttons.forEach((b, i) => { if (i === correctIdx) b.classList.add('opt-correct'); });
                if(!isPreviewMode) {
                    staffWrongs.push({
                        qText: currentLang === 'en' ? q.question_en : (q.question_ms || q.question_en),
                        userChoice: btn.innerText,
                        correctText: currentLang === 'en' ? q[`opt${correctIdx + 1}_en`] : (q[`opt${correctIdx+1}_ms`] || q[`opt${correctIdx+1}_en`])
                    });
                }
            }
            if (quizIdx < currentQuizData.length - 1) document.getElementById('next-btn').classList.remove('hidden');
            else isPreviewMode ? document.getElementById('finish-preview-btn').classList.remove('hidden') : document.getElementById('submit-quiz-btn').classList.remove('hidden');
        }

        function nextQuestion() { quizIdx++; renderQuestion(); }

        async function saveQuizResult() {
            isQuizRunning = false; setLoader(true, "Saving Result...");
            const p = { action: 'save_result', name: document.getElementById('staff-name').value.toUpperCase().trim(), outlet: document.getElementById('staff-outlet').value, topic: document.getElementById('staff-topic').value, score: `${score}/${currentQuizData.length}`, perc: Math.round((score/currentQuizData.length) * 100) + "%", wrongAnswers: staffWrongs };
            try { await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(p) }); alert("Done!"); location.reload(); }
            catch(e) { alert("Sync Error"); setLoader(false); }
        }

        async function autoSubmitQuiz() {
            const p = { action: 'save_result', name: document.getElementById('staff-name').value.toUpperCase().trim(), outlet: document.getElementById('staff-outlet').value, topic: document.getElementById('staff-topic').value, score: `ABANDONED_${score}`, perc: "0%", wrongAnswers: [] };
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(p) });
        }

        function loginManager() {
            if(document.getElementById('mgr-pass').value === "1234") {
                const id = document.getElementById('mgr-select').value;
                const o = document.getElementById('mgr-outlet').value;
                const m = managerData.find(x => x.id === id);
                if (m && m.outlets.includes(o)) {
                    document.getElementById('disp-mgr-name').innerText = id;
                    document.getElementById('disp-mgr-outlet').innerText = o;
                    showView('view-manager-form');
                    // RESET FORM ON LOGIN
                    document.getElementById('rep-topic-filter').value = "";
                    document.getElementById('rep-staff').innerHTML = '<option value="">Choose Topic First...</option>';
                } else alert("Outlet access denied.");
            } else alert("Invalid Pin.");
        }

        function updateMgrOutlets() {
            const id = document.getElementById('mgr-select').value;
            const outS = document.getElementById('mgr-outlet');
            const m = managerData.find(x => x.id === id);
            outS.innerHTML = '<option value="">Select Outlet</option>';
            if(m) m.outlets.forEach(o => outS.innerHTML += `<option value="${o}">${o}</option>`);
        }

        async function submitManagerReport() {
            if(!document.getElementById('rep-date').value) return alert("Select date");
            setLoader(true, "Processing...");
            const p = { action: 'save_report', manager: document.getElementById('disp-mgr-name').innerText, outlet: document.getElementById('disp-mgr-outlet').innerText, staffName: document.getElementById('rep-staff').value, staffScore: document.getElementById('disp-staff-perc').innerText, trainTitle: document.getElementById('rep-topic-filter').value, trainingDate: document.getElementById('rep-date').value, level: document.getElementById('disp-staff-level').innerText, comments: document.getElementById('mgr-comment').value, focus: document.getElementById('mgr-housebrand').value, gaps: document.getElementById('mgr-gaps').value, rec: document.getElementById('mgr-recom').value };
            
            try { 
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(p) });
                const result = await res.text();
                if (result === "AUTH_ERROR") {
                    alert("‚ùå ACCESS DENIED: Only the original author can edit this report.");
                } else if (result === "UPDATE_SUCCESS") {
                    alert("üìù SUCCESS: Existing report has been updated.");
                    await fetchData(); showView('view-main');
                } else {
                    alert("‚úÖ SUCCESS: New report saved.");
                    await fetchData(); showView('view-main');
                }
            } catch(e) { alert("Network Error"); }
            setLoader(false);
        }

        function formatToPercent(v) {
            let n = parseFloat(v);
            if(isNaN(n)) return "0%";
            if (n > 0 && n <= 1) return Math.round(n * 100) + "%";
            return Math.round(n) + "%";
        }

        function renderSupervisorStats() {
            document.getElementById('stat-staff').innerText = [...new Set(allResults.map(r => r.Name))].length;
            document.getElementById('stat-reports').innerText = allReports.length;
            document.getElementById('stat-outlets').innerText = [...new Set(allResults.map(r => r.Outlet))].length;
            const avg = allResults.length ? Math.round(allResults.reduce((a,b) => a + parseInt(formatToPercent(b.Percentage)), 0) / allResults.length) : 0;
            document.getElementById('stat-avg').innerText = avg + "%";
            renderReportsTable(allReports.sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp)).slice(0, 20));
            const g = {};
            allWrongAnswers.forEach(w => {
                const q = w["Question Text"];
                if(!g[q]) g[q] = { c: w["Correct Answer"], n: 0 };
                g[q].n++;
            });
            const s = Object.entries(g).sort((a,b) => b[1].n - a[1].n).slice(0, 8);
            document.getElementById('table-gaps').innerHTML = s.map(([q, d]) => `<tr><td class="p-3 font-medium">${q}</td><td class="p-3 text-green-600 font-bold">${d.c}</td><td class="p-3 text-center"><span class="bg-red-100 text-red-600 px-3 py-1 rounded-full font-black text-xs">${d.n}</span></td></tr>`).join('');
            document.getElementById('table-log').innerHTML = allResults.sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp)).slice(0, 50).map(r => `<tr><td class="p-3 text-xs text-slate-400">${new Date(r.Timestamp).toLocaleDateString('en-GB')}</td><td class="p-3 font-bold uppercase">${r.Name}</td><td class="p-3 text-xs">${r.Outlet}</td><td class="p-3 text-indigo-600 font-bold">${formatToPercent(r.Percentage)}</td><td class="p-3 text-xs text-slate-400 italic">${r.Topic}</td></tr>`).join('');
        }

        function renderReportsTable(data) {
            document.getElementById('table-reports').innerHTML = data.map(r => `<tr><td class="p-3 font-bold">${r["Staff Name"]}</td><td class="p-3 text-xs">${r["Outlet"]}</td><td class="p-3 uppercase font-black text-indigo-600 text-[10px]">${r["Skill Level"]}</td><td class="p-3 text-xs italic">${r["Performance Gaps"] || 'None'}</td><td class="p-3 text-xs">${r["Recommendations"] || 'N/A'}</td></tr>`).join('');
        }

        function filterReports() {
            const query = document.getElementById('report-search').value.toUpperCase().trim();
            const filtered = allReports.filter(r => (r["Staff Name"] && r["Staff Name"].toUpperCase().includes(query)) || (r["Outlet"] && r["Outlet"].toUpperCase().includes(query)));
            renderReportsTable(filtered.slice(0, 20));
        }

        function exportComprehensiveCSV() {
            if (allResults.length === 0) return alert("No data available.");
            const wrap = (t) => `"${(t || "").toString().replace(/"/g, "'").trim()}"`;
            let maxErrors = 0;
            allResults.forEach(r => {
                const errs = allWrongAnswers.filter(w => w["Staff Name"].trim().toUpperCase() === r.Name.trim().toUpperCase() && w["Topic"] === r.Topic);
                if (errs.length > maxErrors) maxErrors = errs.length;
            });
            let csv = "Timestamp,Outlet,Staff_Name,Topic,Quiz_Score,Accuracy,Manager_Level,Comments,Housebrand_Focus,Performance_Gaps,Recommendations,Manager_Name";
            for (let i = 1; i <= maxErrors; i++) csv += `,Question_${i},Choice_${i},Correct_${i}`;
            csv += "\n";
            allResults.forEach(r => {
                const sName = r.Name.trim().toUpperCase();
                const sTopic = r.Topic.trim();
                const rep = allReports.find(x => x["Staff Name"].trim().toUpperCase() === sName && x["Training Title"].trim() === sTopic);
                const errors = allWrongAnswers.filter(w => w["Staff Name"].trim().toUpperCase() === sName && w["Topic"].trim() === sTopic);
                let row = [wrap(r.Timestamp), wrap(r.Outlet), wrap(r.Name), wrap(r.Topic), wrap(r.Score), wrap(formatToPercent(r.Percentage)), wrap(rep ? rep["Skill Level"] : "Pending Review"), wrap(rep ? rep["Competency Comments"] : "N/A"), wrap(rep ? rep["Housebrand Focus"] : "N/A"), wrap(rep ? rep["Performance Gaps"] : "N/A"), wrap(rep ? rep["Recommendations"] : "N/A"), wrap(rep ? rep["Manager"] : "N/A")].join(",");
                errors.forEach(e => { row += `,${wrap(e["Question Text"])},${wrap(e["User Choice"])},${wrap(e["Correct Answer"])}`; });
                for (let i = errors.length; i < maxErrors; i++) row += `,,,`;
                csv += row + "\n";
            });
            const b = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const l = document.createElement("a");
            l.href = URL.createObjectURL(b);
            l.download = `RT_Full_Report_${new Date().toLocaleDateString()}.csv`;
            l.click();
        }

        function loginSupervisor() { if(document.getElementById('sup-pass').value === "admin") { renderSupervisorStats(); showView('view-supervisor-dash'); } else alert("Denied"); }
    </script>
</body>
</html>
